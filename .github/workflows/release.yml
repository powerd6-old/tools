name: Release

on:
    workflow_dispatch:
        inputs:
            version:
                description: 'New version'
                required: true
                type: string

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3.3.0
        - uses: actions/cache@v3
          with:
            path: |
              ~/.cargo/bin/
              ~/.cargo/registry/index/
              ~/.cargo/registry/cache/
              ~/.cargo/git/db/
            key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        - uses: actions/cache@v3
          with:
            path: |
              target/
            key: ${{ runner.os }}-cargo-target-${{ hashFiles('**/Cargo.lock') }}
        - name: Build (w/ release flag)
          run: |-
            cargo build --workspace
            build:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v3.3.0
                - uses: actions/cache@v3
                  with:
                    path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                    key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
                - uses: actions/cache@v3
                  with:
                    path: |
                      target/
                    key: ${{ runner.os }}-cargo-target-${{ hashFiles('**/Cargo.lock') }}
                - name: Build
                  run: |-
                    cargo build --workspace --release
    update-changelog:
        runs-on: ubuntu-latest
        permissions:
          contents: write
        steps:
            - uses: actions/checkout@v3.3.0
            - name: Update CHANGELOG.md
              run: |-
                today="$(date '+%Y-%m-%d')"
                sed -i "" "s/## \[Unreleased\]/## \[Unreleased\]\n\n## [${{ inputs.version }}] - $today/g" 'CHANGELOG.md'
            - uses: stefanzweifel/git-auto-commit-action@v4
              with:
                commit_message: "Release: ${{ inputs.version }}"
                commit_options: '--no-verify --signoff'
                commit_user_name: Powerd6 Automation
                commit_user_email: release@powerd6.org
                commit_author: Powerd6 Automation <release@powerd6.org>
                tagging_message: "v${{ inputs.version }}"